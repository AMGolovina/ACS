# Отчет АКОС ИДЗ 3
Головина Арина БПИ244  

## Вариант 5
Задача о читателях и писателях. Базу данных, представленную массивом целых положительных чисел, разделяют два типа процессов: N читателей и K писателей. 
Читатели периодически просматривают случайные записи базы данных и выводят свой номер (например, PID), индекс записи, ее значение, а также вычисленное значение числа Фибоначчи. 
Писатели изменяют случайные записи на случайное число и также выводят информацию о своем номере, индексе записи, старом значении и новом значении. 
Предполагается, что в начале БД находится в непротиворечивом состоянии (все числа отсортированы, например, по возрастанию). 
Каждая отдельная новая запись переводит БД из одного непротиворечивого состояния в другое (то есть, новая сортировка может поменять индексы записей или переставить числа). 
Для предотвращения взаимного влияния транзакций процесс–писатель должен иметь исключительный доступ к БД. 
Если к БД не обращается ни один из процессов–писателей, то выполнять транзакции могут одновременно сколько угодно читателей.
Создать многопроцессное приложение с процессами-писателями и процессами-читателями.

---

## на 4-6 баллов
Программа, в которой один родительский процесс запускает и использует требуемое число дочерних процессов.
### 1. Сценарий решаемой задачи:
База данных - это массив из 20 элементов, которые отсортированны по возрастанию вначале работы программы, следовательно числа от 1 до 20.
Количество писателей и читателей генерится рандомно вначале работы программы максимум может быть 5 писателей и читателей, минимум по одному.
Процессы писатели выбирает рандомный элемент от 1 до 1000.

`parent_sigint(int signo)` - устанавливает `terminate = 1`, чтобы все процессы завершились.

`fib(int n)` - вычисляет числа Фибоначи.

`reader_process(int id)` - процесс-читатель, читает рандомно из базы данных один элемент.

`qsort` - сортировка массива.

`writer_process(int id)` - процесс‑писатель, выбирает случайный элемент массива, заменяет его случайным числом от 1 до 1000 и затем пересортировывает весь массив с помощью `qsort` для перехода в новое непротиворечивое состояние.

`cleanup_parent()` - очищает ресурсы.
1. Рандомно задается число читателей и писателей от 1 до 5 в N и K и выводится информация о получившемся количестве в консоль.
2. Создается или открывается`shared memory` и получаем доступ к памяти с проверками на корректность.
3. Инициализируются база данных и служебные поля `read_count` и `terminate`.
4. Создаются семафоры.
5. Устанавливается обработчик `SIGINT`, при нажатии `Ctrl+C` вызывается `parent_sigint` и программа завершается.
6. Далее два цикла создают процессы-писатели и процессы-читатели через `fork()` в функциях `reader_process(i)` и `writer_process(i)`.
7. Родитель ставит `wait()` и ожидая завершения процессов, далее очистка и завершение.
### 2. Семафоры:
Множество процессов взаимодействуют с использованием **неименованных** POSIX семафоров.
- `sem_t mutex;` — семафор, защищающий счётчик активных читателей.
- `sem_t rw_mutex;` — семафор для взаимного исключения между писателями и множеством читателей.
### 3. Обмен данных:
Обмен данными ведется через разделяемую память в стандарте POSIX.

- в `reader_process` читатель читает `shared->db[idx]` и использует общие поля `read_count`, `terminate`.
```
int idx = rand() % 20;
int value = shared->db[idx];
...
shared->read_count++;
...
shared->read_count--;
```
- в `writer_process` писатель читает и меняет элементы массива `shared->db` в той же общей памяти и сортирует массив по возрастанию.
```
int idx = rand() % 20;
int old = shared->db[idx];
int new_val = (rand() % 1000) + 1;
shared->db[idx] = new_val;
qsort(shared->db, 20, sizeof(int), int_cmp);
```
### 4. Завершение программы:
Основной сценарий завершения - по Ctrl+C
### 5. Вывод в общий поток:
- в `reader_process`:
```
printf("READER %d | PID=%d : idx=%d value=%d fib=%d\n", id, getpid(), idx, value, fib_val);
```
`id` - id читателя;

`getpid()` - PID читателя;

`idx` - индекс элемента массива;

`value` - значение элемента массива;

`fib_val` - число Фибонначи для данного значения.
- в `writer_process`:
```
printf("WRITER %d | PID=%d : idx=%d old=%d new=%d\n", id, getpid(), idx, old, new_val);
```
`id` - id писателя;

`getpid()` - PID писателя;

`idx` - индекс элемента массива;

`old` - старое значение элемента массива;

`new_val` - новое значение элемента массива.
### 6. Удаление семафоров и разделяемой памяти по ее завершению:
- неименованные семафоры: `sem_destroy`;
- разделяемая память: `close` + `shm_unlink`.
### 7. Результаты работы программы:
<img width="571" height="386" alt="Снимок экрана 2025-11-29 в 22 11 35" src="https://github.com/user-attachments/assets/0c48ead7-9e90-44b6-8eaf-55cc349336ed" />

---
## 
